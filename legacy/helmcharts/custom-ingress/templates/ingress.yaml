apiVersion: networking.k8s.io/v1beta1
kind: Ingress
# data:
#   hsts: {{ .Values.route_hsts }}
#   hsts-max-age: {{ .Values.route_hsts }}
#   ssl-redirect: true
metadata:
  name: {{ include "custom-ingress.fullname" . }}
  labels:
    dioscuri.amazee.io/migrate: {{ .Values.routeMigrate | quote }}
    lagoon.sh/autogenerated: "false"
    {{- include "custom-ingress.labels" . | nindent 4 }}
  annotations:
    # force-ssl-redirect handling
    {{- if eq .Values.insecure "Allow"}}
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    ingress.kubernetes.io/ssl-redirect: "false"
    {{- else if eq .Values.insecure "Redirect"}}
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    ingress.kubernetes.io/ssl-redirect: "true"
    {{- else if eq .Values.insecure "None"}}
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    ingress.kubernetes.io/ssl-redirect: "true"
    {{- end }}
    monitor.stakater.com/enabled: "{{ .Values.ingressmonitorcontroller.enabled }}"
    uptimerobot.monitor.stakater.com/interval: "{{ .Values.ingressmonitorcontroller.interval }}"
    uptimerobot.monitor.stakater.com/alert-contacts: "{{ .Values.ingressmonitorcontroller.alertContacts }}"
    {{- if .Values.ingressmonitorcontroller.path }}
    monitor.stakater.com/overridePath: "{{ .Values.ingressmonitorcontroller.path }}"
    {{- end }}
    {{- if .Values.ingressmonitorcontroller.statuspageId }}
    uptimerobot.monitor.stakater.com/status-pages: "{{ .Values.ingressmonitorcontroller.statuspageId }}"
    {{- end }}
    # HSTS Handling
    {{- if .Values.hsts}}
    # haproxy.router.openshift.io/hsts_header: {{ .Values.route_hsts }}
    {{ end -}}
    kubernetes.io/tls-acme: {{ .Values.tls_acme | quote }}
    {{- include "custom-ingress.annotations" . | nindent 4 }}
    {{- with .Values.annotations }}
      {{- toYaml . | nindent 4  }}
    {{- end }}
spec:
  tls:
    - hosts:
        -  {{ .Values.host }}
      secretName: {{ include "custom-ingress.fullname" . }}-tls
  rules:
    - host: {{ .Values.host }}
      http:
        paths:
          - backend:
              serviceName: {{ .Values.service }}
              servicePort: http
