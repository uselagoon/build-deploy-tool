When a build pod first starts up, it runs through some checks to ensure that the docker-host it needs to talk to is available. It also establishes a client to use to talk to Kubernetes.

# Git Checkout

Once the setup is complete, the build proceeds to checkout the git repository and any submodules it may have. Any repositories configured as submodules must be allowed to be pulled using the same key as the primary git repository. 

!!! warning
    This may need the `deploy key` of the project be assigned to a git user, and that user then granted access to the repositories required.

# Kubernetes Setup

This stage ensures that a client can talk to Kubernetes. Also, all builds are configured to talk to a dedicated container registry, in most cases this will be a Harbor that is configured in `lagoon-remote`, checks to ensure this information is present occur here too.

# Initial Environment Setup

This stage saves a copy of the `.lagoon.yml` and `docker-compose.yml` file into the namespace before the build proceeds. This allows administrators to perform debugging if required with a copy of these files to detect potential changes.

# Docker Compose and Lagoon YAML Validations

This stage validates the `.lagoon.yml` and associated `docker-compose.yml` files to ensure they are valid. This step can produce build warnings that describe issues that should be addressed, as warnings indicate that a failure may occur in the future if behaviour changes.

# Variable Configuration

This stage sets up variables used internally during the build to store and process information later during the build.

# Container Registry Login

This stage logs in to the internally provided container registry. As Lagoon also supports [user defined external container registries](https://docs.lagoon.sh/concepts-basics/lagoon-yml/#container-registries), these are also configured and logged in during this step.

# Image Build

This stage is where the images are built. By default `buildkit` is enabled, but this can be disabled by setting the `DOCKER_BUILDKIT=0` as a build scope variable. 

!!! info
    These images are not tagged and are referenced in Lagoon deployments using the build image `SHA`.

# Pre-Rollout Tasks

This stage runs any pre-rollout tasks that may be configured in the `.lagoon.yml` file. These tasks are treated as a failure item and will result in a build failing if they fail. If you don't want these tasks to fail, you will need to write your tasks in a way to always `exit 0`.

# Service Configuration 1 & 2

These stages proceed to configure autogenerated routes and any DBaaS services.

# Route/Ingress Configuration

This stage calculates and creates any ingress for the environment.

# Route/Ingress Cleanup

This stage calculates any ingress that need to be removed. Currently Lagoon will provide a warning in the build if it detects anything, but will not remove anything.

Setting `LAGOON_FEATURE_FLAG_CLEANUP_REMOVED_LAGOON_ROUTES=enabled` as a global scope variable will ensure that any ingress previously detected will be removed during the next build. A warning will be produced in both situations to inform the user that something has taken place.

# Route/Ingress Certificate Challenges

If the `lagoon-remote` has been configured with cert-manager, and any ingress have certificate challenges that are still pending or failing, this stage will report them in a warning for the user to either confirm if the routes are required, or to ensure DNS is correctly configured.

# Update Configmap

This stage updates the configmap that stores variables from the project or environment in Lagoon, plus any of the variables that are provided by the build, typicaly prefixed with `LAGOON_`.

# Image Push to Registry

This stage pushes any built or pulled through images into the internally configured registry.

!!! info
    These images are not tagged and are referenced in Lagoon deployments using the build image `SHA`.

# Deprecated Image Warnings

If any images built or pulled contain an image that Lagoon has detected as deprecated, a warning will be shown here to indicate which images have issues. See more information in the docs [here](https://docs.lagoon.sh/docker-images/deprecated-images/).

# Backup Configruation

This stage configures any backup schedules as required. Backups in Lagoon use [k8up](https://k8up.io/).

# Deployment Templating

This stage templates out the deployments, this includes the Kubernetes kinds of `deployment`, `service`, `persistentvolumeclaim`, or any other kinds that may be supported.

# Applying Deployments

This stage actually applies the resources to Kubernetes and waits for the pods to rollout. Any errors here could be due to pods failing to start or schedule. The output of the failure should help indicate why.

# Cronjob Cleanup

This stage ensures that only cronjobs defined in the `.lagoon.yml` are configured by removing any that may have been removed from the `.lagoon.yml` file.

# Post-Rollout tasks

This stage runs any post-rollout tasks that may be configured in the `.lagoon.yml` file. These tasks are treated as a failure item and will result in a build failing if they fail. If you don't want these tasks to fail, you will need to write your tasks in a way to always `exit 0`.

# Build and Deploy

This stage indicates the completion of the build, a copy of the `.lagoon.yml` and `docker-compose.yml` files are saved again here to aid in future debugging if required.

# Insights Gathering

This stage runs after the build has completed, but will only generate warnings if it fails to complete. This is used by Lagoon to generate insights or collect security information about the images that were built and this is then sent to Lagoon. 

!!! info
    This stage is not enabled by default, it can result in builds taking longer to show as complete. This stage will eventually be moved out of the build process to run externally to the build.

